<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css"  media="screen,projection"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Lifebox Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="socket.io/socket.io.js"></script>
</head>
<body>
    <nav class="black">
        <div class="nav-wrapper container">
            <a href="#" class="brand-logo">Lifebox Dashboard</a>
        </div>
    </nav>
    <div class="container">
        <div id="first-section" class="section row">
            <div id="tombamentos" class="col s3">
                <div class="label">Tombamentos</div>
                <div id="vlr-tombamentos"></div>
            </div>
        
            <div id="colisoes" class="col s3">
                <div class="label">Colisões</div>
                <div id="vlr-colisoes"></div>
            </div>
        
            <div id="amplitude" class="col s3">
                <div class="label">Amplitude</div>
                <div id="vlr-amplitude"></div>
            </div>
        
            <div id="frequencia" class="col s3">
                <div class="label">Frequência</div>
                <div id="vlr-frequencia"></div>
            </div>
        
        </div> <!-- #first-section .section .row -->
        
        <div class="divider"></div>

        <div id="second-section" class="section row">
            <div class="col s6">
                <div id="history">
                    <h5>Histórico de eventos</h5>
                </div>
            </div>
            <div class="col s6">
                <div id="map"></div>
            </div>
        </div><!-- #second-section .section .row -->

    </div> <!-- .conteiner -->

    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript" src="materialize/js/materialize.min.js"></script>
    <script type="text/javascript" src="googlemaps.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIet2blAyLXgnz6pmYCWO5tOw-DI4Nx6M&callback=myMap" defer></script>
    <script type="module">

        let data = {}

        function renderMap() {
            const coordinates = []
            
            data.historicoCoordenadas.map(
                c => coordinates.push(new google.maps.LatLng(c.lat, c.lon))
            );

            if (coordinates.length > 0) {
                const lastPosition = coordinates[coordinates.length-1]
                map.setCenter(lastPosition)
                
                const marker = new google.maps.Marker({
                    position: lastPosition,
                    map: map
                });
            }
            
            const strokePath = new google.maps.Polyline({
                path: coordinates,
                geodesic: true,
                strokeColor: 'blue',
                strokeOpacity: 0.8,
                strokeWeight: 2
            });

            strokePath.setMap(map);
        }

        function renderScreen() {
            // atualiza os mostradores
            document.getElementById("vlr-tombamentos").innerHTML = data.tombamentos;
            document.getElementById("vlr-colisoes").innerHTML = data.colisoes;
            document.getElementById("vlr-amplitude").innerHTML = data.amplitude+" G";
            document.getElementById("vlr-frequencia").innerHTML = data.frequencia+" Hz";

            // atualiza o mapa
            renderMap()
        }

        const socket = io()

        socket.on('connect', () => {
            console.log(`Client connected with id: ${socket.id}`)
        })

        socket.on('setup', (state) => {
            console.log('Receiving "setup" event from server', state)
            data = state
            renderScreen()
            console.log('New state', data)
        })

        socket.on('update', (state) => {
            console.log('Receiving "update" event from server', state)
            data = state
            renderScreen()
            console.log('New state', data)
        })
    </script>
</body>
</html>